<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='stylesheet.css') }}"
    />
    <title>PopcornPicksüçø</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark topNavBar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">PopcornPicksüçø</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <!-- <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <div class="d-flex">
            <a class="nav-link" href="#">Link</a>
          </div>
        </div> -->
      </div>
    </nav>
    <div class="heading1">
      <div class="d-flex">
        <h2>üé¨Pick a Movie!üé¨</h2>
      </div>
      <div class="d-flex">
        <p style="width: 560px; margin: auto">
          <label>Search Here</label>&nbsp;&nbsp;<input
            type="text"
            name="search"
            id="searchBox"
          />
        </p>
      </div>
    </div>

    <div>
      <input class="c-checkbox" type="checkbox" id="checkbox" />
      <div class="c-formContainer">
        <form class="c-form" action="">
          <input
            class="c-form__input"
            placeholder="E-mail"
            type="email"
            pattern="[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{1,63}$"
            required
          />
          <label class="c-form__buttonLabel" for="checkbox">
            <button class="c-form__button" type="button">Send</button>
          </label>
          <label
            class="c-form__toggle"
            for="checkbox"
            data-title="Notify me"
          ></label>
        </form>
      </div>
    </div>

    <!-- <div style="width: 600px; margin: auto">
      <h2>Please select movies for training</h2>
      <p style="width: 560px; margin: auto">
        <label>Search Here</label>&nbsp;&nbsp;<input
          type="text"
          name="search"
          id="searchBox"
        />
      </p>
    </div> -->
    <div style="width: 600px; margin: auto">
      <h2>Selected movie :</h2>
      <ul id="selectedMovies"></ul>
    </div>
    <div style="width: 600px; margin: auto">
      <input
        type="button"
        class="btn btn-primary"
        name="predict"
        id="predict"
        value="Predict"
      />
    </div>
    <div style="width: 600px; margin: auto">
      <h2>Predicted Movies</h2>
      <form class="recos" id="recos">
        <ul id="predictedMovies"></ul>
      </form>
    </div>
    <div style="width: 600px; margin: auto">
      <input
        type="button"
        class="btn btn-primary"
        name="feedback"
        data-toggle="modal"
        id="feedback"
        value="Give Feedback"
        data-target="#exampleModalCenter"
      />
      <!--TODO Button trigger modal-->
      <button
        type="button"
        data-bs-toggle="modal"
        data-bs-target="#exampleModalCenter"
      >
        button
      </button>
      <div
        class="modal fade"
        id="exampleModalCenter"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">
                Modal title
              </h5>
              <button
                type="button"
                class="close"
                data-bs-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">...</div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="button" class="btn btn-primary">
                Save changes
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <input class="c-checkbox" type="checkbox" id="checkbox" />
    <div id="dataCollected" style="width: 600px; margin: auto; display: none">
      <h1>Thanks!! Your response was stored.</h1>
      <input
        type="button"
        id="refreshPage"
        class="btn btn-danger"
        name="refreshPage"
        value="Take another attempt"
      />
    </div>
    <br /><br /><br />
  </body>
  <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
    crossorigin="anonymous"
  ></script>
  <script>
    $(document).ready(function () {
      $(function () {
        $("#searchBox").autocomplete({
          source: function (request, response) {
            $.ajax({
              type: "POST",
              url: "http://localhost:5000/search",
              dataType: "json",
              cache: false,
              data: {
                q: request.term,
              },
              success: function (data) {
                //alert(data);
                // console.log(data);
                response(data);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                console.log(textStatus + " " + errorThrown);
              },
            });
          },
          select: function (event, ui) {
            var ulList = $("#selectedMovies");
            // Check if the value already exists in the list
            if (
              ulList.find('li:contains("' + ui.item.value + '")').length > 0
            ) {
              $("#searchBox").val("");
              return false;
            }

            var li = $("<li/>").text(ui.item.value).appendTo(ulList);
            $("#searchBox").val("");
            return false;
          },

          // changed the min-length for searching movies from 2 to 1
          minLength: 1,
        });
      });

      $("#predict").click(function () {
        var movie_list = [];

        $("#selectedMovies li").each(function () {
          movie_list.push($(this).text());
        });

        var movies = { movie_list: movie_list };

        // Clear the existing recommendations
        $("#predictedMovies").empty();
        
        // if movies list empty then throw an error box saying select atleast 1 movie!!

        $.ajax({
          type: "POST",
          url: "/predict",
          dataType: "json",
          contentType: "application/json;charset=UTF-8",
          traditional: "true",
          cache: false,
          data: JSON.stringify(movies),
          success: function (response) {
            var ulList = $("#predictedMovies");
            var i = 0;
            response["recommendations"].forEach((element) => {
              var diventry = $("<div/>");
              var fieldset = $("<fieldset/>", { id: i }).css("border", "0");
              var li = $("<li/>").text(element);
              var radios = $(
                "<label class='radio-inline'><input type='radio' name=" +
                  i +
                  " value=1>Dislike</label> \
                        <label class='radio-inline'><input type='radio' name=" +
                  i +
                  " value=2>Yet to watch</label> \
                        <label class='radio-inline'><input type='radio' name=" +
                  i +
                  " value=3>Like</label><br/><br/>"
              );
              diventry.append(li);
              diventry.append(radios);
              fieldset.append(diventry);
              ulList.append(fieldset);
              i += 1;
            });

            // var li = $('<li/>').text()
            console.log("->", response["recommendations"]);
          },
          error: function (error) {
            console.log("ERROR ->" + error);
          },
        });
      });

      $("#feedback").click(function () {
        var myForm = $("fieldset");
        var data = {};
        var labels = {
          1: "Dislike",
          2: "Yet to watch",
          3: "Like",
        };
        for (var i = 0; i < myForm.length; i++) {
          var input = $("#" + i)
            .find("div")
            .find("input:checked")[0].value;
          var movieName = $("#" + i)
            .find("div")
            .find("li")[0].innerText;
          data[movieName] = labels[input];
        }
        console.log(data);

        $.ajax({
          type: "POST",
          url: "/feedback",
          dataType: "json",
          contentType: "application/json;charset=UTF-8",
          traditional: "true",
          cache: false,
          data: JSON.stringify(data),
          success: function (response) {
            window.location.href = "/success";
          },
          error: function (error) {
            console.log("ERROR ->" + error);
          },
        });
      });
    });
  </script>
</html>
